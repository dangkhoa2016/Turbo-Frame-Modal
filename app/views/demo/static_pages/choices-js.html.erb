<style>
[data-label-class='search-hint'] {
  display: none;
}
</style>

<div class='container px-4 mx-auto bg-white my-5'>
  <h1 class='fs-3 fw-semibold text-center mb-5'>Choices.js Demo</h1>

  <div class='row'>
    <div class='col'>
      <label for='pet-select'>Choose a pet:</label>
      <div data-controller='choices'>
        <select name='pets' id='pet-select' class='d-none'
          data-placeholder='Choose a pet...' data-choices-target='select'>
          <option value='dog'>Dog</option>
          <option value='cat'>Cat</option>
          <option value='hamster'>Hamster</option>
          <option value='parrot'>Parrot</option>
          <option value='spider'>Spider</option>
          <option value='goldfish'>Goldfish</option>
        </select>
      </div>
    </div>

    <div class='col-md mt-4 mt-md-0'>
      <label for='ff-select'>Your favorite food: (Demo with optgroups)</label>
      <div data-controller='choices'>
        <select name='favorite-foods' id='ff-select' class='d-none'
          data-placeholder='Choose a food...' data-choices-target='select'>
          <optgroup label='Fruit'>
            <option value='apple'>Apples</option>
            <option value='banana'>Bananas</option>
            <option value='cherry'>Cherries</option>
            <option value='damson'>Damsons</option>
          </optgroup>
          <hr />
          <optgroup label='Vegetables'>
            <option value='artichoke'>Artichokes</option>
            <option value='broccoli'>Broccoli</option>
            <option value='cabbage'>Cabbages</option>
          </optgroup>
          <hr />
          <optgroup label='Meat'>
            <option value='beef'>Beef</option>
            <option value='chicken'>Chicken</option>
            <option value='pork'>Pork</option>
          </optgroup>
          <hr />
          <optgroup label='Fish'>
            <option value='cod'>Cod</option>
            <option value='haddock'>Haddock</option>
            <option value='salmon'>Salmon</option>
            <option value='turbot'>Turbot</option>
          </optgroup>
        </select>
      </div>
    </div>
  </div>

  <div class='mt-4'>
    <label for='pets-select'>Your favorite pets: (Demo with multiple)</label>
    <div data-controller='choices'>
      <select name='pets' id='pets-select' class='d-none' multiple
        data-placeholder='Choose pets...' data-choices-target='select'>
        <option value='dog'>Dog</option>
        <option value='cat'>Cat</option>
        <option value='hamster'>Hamster</option>
        <option value='parrot'>Parrot</option>
        <option value='spider'>Spider</option>
        <option value='goldfish'>Goldfish</option>
        <option value='horse'>Horse</option>
        <option value='rabbit'>Rabbit</option>
        <option value='turtle'>Turtle</option>
        <option value='snake'>Snake</option>
        <option value='lizard'>Lizard</option>
        <option value='frog'>Frog</option>
      </select>
    </div>
  </div>

  <div class='mt-4'>
    <label for='my-select'>Choose a pet: (Demo with remote data)</label>
    <div data-controller='choices-remote-data'
      data-choices-remote-data-fetch-url-value='/demo/pets'>
      <select name='pet' class='d-none'
        data-placeholder='Choose a pet...'
        data-choices-remote-data-target='select'></select>
    </div>
  </div>

  <hr class='mt-5 mb-3' />

  <h3 class='fs-4 fw-semibold text-center mb-5'>Cascade Selects</h3>
  <div id='cascade-selects' class='row'>
    <div class='col-md'>
      <label for='my-select2'>Choose a pet: (Demo with remote data)</label>
      <div data-controller='choices-remote-data' data-cascade-selects='parent'
        data-choices-remote-data-fetch-url-value='/demo/pets'>
        <select name='my-select2' id='my-select2' class='d-none'
          data-placeholder='Choose a pet...'
          data-choices-remote-data-target='select'></select>
      </div>
    </div>
    <div class='col-md mt-4 mt-md-0'>
      <label for='select-hobby'>Choose a pet: (Demo with remote data)</label>
      <div data-controller='choices-remote-data' data-cascade-selects='child'
        data-choices-remote-data-disabled-value='true'
        data-choices-remote-data-fetch-url-value='/demo/pet-hobbies'>
        <select name='select-hobby' id='select-hobby' class='d-none'
          data-placeholder='Choose a hobby...'
          data-choices-remote-data-target='select'></select>
      </div>
    </div>
  </div>
</div>

<script>
function waitForStimulus(callback) {
  if (window.Stimulus) {
    callback();
  } else {
    setTimeout(() => waitForStimulus(callback), 50); // Retry after 50ms
  }
}

waitForStimulus(() => {
  const cascadeSelects = document.querySelector('#cascade-selects');
  if (!cascadeSelects)
    return;

  let parentElement = null;
  let childElement = null;
  const elements = cascadeSelects.querySelectorAll('[data-controller="choices-remote-data"]');
  if (elements.length === 0)
    return;

  elements.forEach((element) => {
    if (element.getAttribute('data-cascade-selects') === 'parent')
      parentElement = element;
    else if (element.getAttribute('data-cascade-selects') === 'child')
      childElement = element;
  });

  // const parentController = Stimulus.getControllerForElementAndIdentifier(parentElement, 'choices-remote-data');
  const childController = Stimulus.getControllerForElementAndIdentifier(childElement, 'choices-remote-data');
  console.log('childController element', childController);

  const cacheChildElementFetchUrlValue = childElement.getAttribute('data-choices-remote-data-fetch-url-value');
  parentElement.addEventListener('choices-remote-data:change', (event) => {
    console.log('Select change event', event);

    if (event.detail.value)
      childElement.setAttribute('data-choices-remote-data-fetch-url-value', `${cacheChildElementFetchUrlValue}?pet=${event.detail.value.value}`);
    else {
      childController.clearSelection(true);
      childController.disableSelect();
      return;
    }

    childController.enableSelect();
  });
});
</script>
